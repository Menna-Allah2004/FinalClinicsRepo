@model MedicalConnect.ViewModels.DoctorSearchViewModel

@{
    ViewData["Title"] = "الأطباء";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Doctors Header -->
<div class="pt-5 bg-medical-50">
    <div class="container pt-5 pb-4">
        <div class="text-center my-5">
            <h1 class="display-5 fw-bold text-dark mb-3">ابحث عن أفضل الأطباء المتخصصين</h1>
            <p class="text-muted mx-auto" style="max-width: 700px;">
                قائمة شاملة بأفضل الأطباء المتخصصين في مختلف المجالات الطبية من مختلف أنحاء قطاع غزة
            </p>
        </div>

        <!-- Search and Filters -->
        <form method="get" asp-action="Index">
            <div class="bg-white p-4 rounded-4 shadow-sm mb-5">
                <div class="row g-3">
                    <div class="col-md-5">
                        <div class="position-relative">
                            <i class="fas fa-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                            <input type="text" name="searchQuery" value="@Model.SearchQuery"
                                   class="form-control ps-5 py-2 rounded-3"
                                   placeholder="ابحث باسم الطبيب أو التخصص">
                        </div>
                    </div>

                    <div class="col-md-3">
                        <select name="specialty" class="form-select py-2 rounded-3" onchange="this.form.submit()">
                            @foreach (var specialty in Model.Specialties)
                            {
                                <option value="@specialty" selected="@(Model.SelectedSpecialty == specialty)">
                                    @specialty
                                </option>
                            }
                        </select>
                    </div>

                    <div class="col-md-3">
                        <select name="location" class="form-select py-2 rounded-3" onchange="this.form.submit()">
                            @foreach (var location in Model.Locations)
                            {
                                <option value="@location" selected="@(Model.SelectedLocation == location)">
                                    @location
                                </option>
                            }
                        </select>
                    </div>

                    <div class="col-md-1">
                        <button type="button" id="toggleAdvancedFilters"
                                class="btn btn-primary w-100 py-2 d-flex align-items-center justify-content-center">
                            <i class="fas fa-filter me-md-2"></i>
                            <span class="d-none d-lg-inline">فلترة</span>
                        </button>
                    </div>
                </div>

                <div id="advancedFilters" class="row g-3 mt-3 pt-3 border-top d-none">
                    <div class="col-md-4">
                        <label class="form-label small fw-medium text-dark mb-2">التقييم</label>
                        <select class="form-select py-2 rounded-3">
                            <option value="">جميع التقييمات</option>
                            <option value="4.5">4.5 نجوم وأعلى</option>
                            <option value="4.0">4.0 نجوم وأعلى</option>
                            <option value="3.5">3.5 نجوم وأعلى</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label small fw-medium text-dark mb-2">سعر الكشف</label>
                        <select class="form-select py-2 rounded-3">
                            <option value="">جميع الأسعار</option>
                            <option value="200">أقل من 20 شيكل</option>
                            <option value="300">أقل من 30 شيكل</option>
                            <option value="400">أقل من 40 شيكل</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label small fw-medium text-dark mb-2">المتاح اليوم</label>
                        <div class="form-check form-switch pt-2">
                            <input class="form-check-input" type="checkbox">
                            <label class="form-check-label">متاح اليوم فقط</label>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <!-- Results info -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <p class="text-muted mb-0">@Model.DoctorCount طبيب متاح</p>
            <select class="form-select form-select-sm py-2 rounded-3" style="width: auto;"
                    onchange="window.location.href='@Url.Action("Index")?searchQuery=@Model.SearchQuery&specialty=@Model.SelectedSpecialty&location=@Model.SelectedLocation&sortBy=' + this.value">
                <option value="rating" selected="@(Model.SortBy == "rating")">الترتيب حسب: التقييم الأعلى</option>
                <option value="experience" selected="@(Model.SortBy == "experience")">الترتيب حسب: الخبرة</option>
                <option value="fee-asc" selected="@(Model.SortBy == "fee-asc")">الترتيب حسب: السعر (الأقل)</option>
                <option value="fee-desc" selected="@(Model.SortBy == "fee-desc")">الترتيب حسب: السعر (الأعلى)</option>
            </select>
        </div>

        <!-- Doctors List -->
        <div class="row g-4 mb-5">
            @foreach (var doctor in Model.Doctors)
            {
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100 rounded-4 border shadow-sm hover-scale">
                        <div class="position-relative">
                            <img src="@Url.Content(string.IsNullOrEmpty(doctor.ImageUrl) ? "~/images/doctors/default-user.png" : doctor.ImageUrl)"
                                 alt="@doctor.FullName"
                                 class="card-img-top rounded-top-4"
                                 style="height: 200px; object-fit: cover;"
                                 onerror="this.onerror=null;this.src='/images/doctors/default-user.png';">
                            <div class="position-absolute top-3 end-3 bg-success text-white px-3 py-1 rounded-pill fs-7">
                                <i class="fas fa-circle text-white me-1" style="font-size: 8px;"></i> @(doctor.Availabilities?.FirstOrDefault()?.IsAvailable == true ? "متاح الآن" : "غير متاح")
                            </div>
                        </div>
                        <div class="card-body p-4">
                            <h4 class="card-title mb-1">@doctor.FullName</h4>
                            <p class="text-primary mb-2">@doctor.Specialty</p>
                            <div class="d-flex align-items-center text-muted mb-3">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                <span>فلسطين - @doctor.City</span>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-star text-warning"></i>
                                    <span class="ms-1 text-dark fw-medium">@doctor.Rating</span>
                                    <span class="text-muted ms-1">(@doctor.RatingCount)</span>
                                </div>
                                <div class="text-muted">
                                    <span class="fw-medium">@doctor.ExperienceYears</span> سنة خبرة
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center py-3 border-top border-bottom mb-3">
                                <div>
                                    <span class="text-muted fs-7">سعر الكشف</span>
                                    <p class="mb-0 fw-bold text-dark">
                                        @(doctor.ConsultationFee != null && doctor.ConsultationFee > 0 ? $"{doctor.ConsultationFee} شيكل" : "غير محدد")
                                    </p>
                                </div>
                                <div>
                                    <span class="text-muted fs-7">مدة الانتظار</span>
                                    <p class="mb-0 fw-bold text-dark">
                                        @(
                                            doctor.Availabilities?.FirstOrDefault()?.WaitingTime != null
                                            && doctor.Availabilities.FirstOrDefault().WaitingTime != ""
                                            ? doctor.Availabilities.FirstOrDefault().WaitingTime + " دقيقة"
                                            : "غير محدد"
                                            )
                                    </p>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <a href="@Url.Action("BookAppointment", "Appointment", new { doctorId = doctor.Id })"
                                   class="btn btn-primary flex-grow-1 d-flex align-items-center justify-content-center">
                                    <i class="fas fa-calendar-alt me-2"></i> حجز موعد
                                </a>
                                <a href="@Url.Action("Details", "Doctors", new { id = doctor.Id })"
                                   class="btn btn-light">عرض الملف</a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- No Results Message -->
        @if (Model.NoResults)
        {
            <div class="text-center py-5">
                <div class="text-medical-500 mb-4">
                    <i class="far fa-sad-tear fa-4x"></i>
                </div>
                <h3 class="fs-4 fw-semibold text-dark mb-3">لم يتم العثور على أطباء</h3>
                <p class="text-muted mb-4">
                    لم نتمكن من إيجاد أطباء مطابقين للفلاتر المحددة. يرجى تغيير معايير البحث والمحاولة مرة أخرى.
                </p>
                <a href="@Url.Action("Index", "Doctor")" class="btn btn-primary px-4 py-2 rounded-3">
                    إعادة ضبط الفلاتر
                </a>
            </div>
        }

        <!-- Pagination -->
        @if (Model.TotalPages > 1)
        {
            <div class="d-flex justify-content-center mt-5">
                <nav>
                    <ul class="pagination">
                        <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { searchQuery = Model.SearchQuery, specialty = Model.SelectedSpecialty, location = Model.SelectedLocation, sortBy = Model.SortBy, page = Model.CurrentPage - 1 })" aria-label="Previous">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>

                        @for (int i = 1; i <= Model.TotalPages; i++)
                        {
                            <li class="page-item @(Model.CurrentPage == i ? "active" : "")">
                                <a class="page-link" href="@Url.Action("Index", new { searchQuery = Model.SearchQuery, specialty = Model.SelectedSpecialty, location = Model.SelectedLocation, sortBy = Model.SortBy, page = i })">@i</a>
                            </li>
                        }

                        <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                            <a class="page-link" href="@Url.Action("Index", new { searchQuery = Model.SearchQuery, specialty = Model.SelectedSpecialty, location = Model.SelectedLocation, sortBy = Model.SortBy, page = Model.CurrentPage + 1 })" aria-label="Next">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        }
    </div>
</div>

<!-- Minimal JavaScript for UI interactions only -->
<script>
    // Toggle Advanced Filters
    document.getElementById('toggleAdvancedFilters').addEventListener('click', function() {
        const advancedFilters = document.getElementById('advancedFilters');
        advancedFilters.classList.toggle('d-none');
    });

    // Auto-submit search form on input change (with delay)
    const searchInput = document.querySelector('input[name="searchQuery"]');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                this.form.submit();
            }, 500);
        });
    }
</script>

<script src="~/js/doctors.js"></script>